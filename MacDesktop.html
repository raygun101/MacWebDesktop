<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Retro Mac OS 9 Desktop - Updated</title>
  <!-- CodeMirror assets for the Code Editor app -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
  <style>
    /* --- Theme Variables --- */
    :root {
      /* Modern theme variables (default) */
      --menubar-bg: rgba(255,255,255,0.6);
      --menubar-border: rgba(0,0,0,0.1);
      --dropdown-bg: rgba(255,255,255,0.8);
      --dropdown-border: rgba(0,0,0,0.1);
      --dropdown-hover-bg: #0a84ff;
      --dropdown-hover-color: #fff;
      --window-bg: #fff;
      --window-border: #666;
      --window-shadow: rgba(0,0,0,0.5);
    }
    .theme-classicos9 {
      /* Classic OS9 look (you can tweak these values to more closely mimic OS9 screenshots) */
      --menubar-bg: #c0c0c0;
      --menubar-border: #808080;
      --dropdown-bg: #d0d0d0;
      --dropdown-border: #808080;
      --dropdown-hover-bg: #0078d7;
      --dropdown-hover-color: #fff;
      --window-bg: #e0e0e0;
      --window-border: #808080;
      --window-shadow: rgba(0,0,0,0.7);
    }
    
    /* Basic reset and fonts */
    body, html {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: "Chicago", sans-serif;
      user-select: none;
    }
    body.theme-modern { /* explicitly assign modern if needed */
      /* no extra overrides â€“ uses :root variables */
    }
    svg#icons { display: none; }
    #drag-layer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 3000;
      pointer-events: none;
    }
    #desktop {
      width: 100%;
      height: 100%;
      position: relative;
      background: none;
    }
    /* Modern macOS-style menu bar */
    #menu-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 24px;
      background: var(--menubar-bg);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--menubar-border);
      display: flex;
      align-items: center;
      padding: 0 5px;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: background 0.3s ease;
    }
    .menu-item {
      margin-right: 15px;
      cursor: pointer;
      position: relative;
      padding: 2px 4px;
      display: flex;
      align-items: center;
    }
    .menu-item svg { margin-right: 4px; }
    /* Dropdown menus with transitions and rounded corners */
    .dropdown {
      position: absolute;
      top: 24px;
      left: 0;
      background: var(--dropdown-bg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--dropdown-border);
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      min-width: 150px;
      padding: 5px 0;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .dropdown.active {
      opacity: 1;
      pointer-events: auto;
    }
    .dropdown li {
      list-style: none;
      padding: 5px 20px;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .dropdown li:hover {
      background: var(--dropdown-hover-bg);
      color: var(--dropdown-hover-color);
    }
    #desktop-clock {
      position: absolute;
      right: 10px;
      top: 2px;
      font-size: 12px;
      color: #333;
    }
    /* Window styling with pop-in and pop-out animations */
    .window {
      position: absolute;
      border: 2px solid var(--window-border);
      background: var(--window-bg);
      box-shadow: 5px 5px 10px var(--window-shadow);
      z-index: 200;
      transition: transform 0.3s ease, opacity 0.3s ease;
      transform: scale(0.95);
      opacity: 0;
    }
    .window.show {
      transform: scale(1);
      opacity: 1;
    }
    .window.closing {
      transform: scale(0.9);
      opacity: 0;
    }
    .window-header {
      background: linear-gradient(to bottom, #ddd, #bbb);
      padding: 4px;
      cursor: move;
      display: flex;
      align-items: center;
    }
    .window-header .window-controls {
      margin-right: 10px;
      display: flex;
      gap: 4px;
    }
    .title { font-weight: bold; }
    .window-controls span {
      width: 16px;
      height: 16px;
      display: inline-block;
      border-radius: 50%;
      cursor: pointer;
    }
    .close { background: red; }
    .minimize { background: yellow; }
    .maximize { background: green; }
    /* Remove extra padding for seamless content */
    .window-content {
      padding: 0;
      height: calc(100% - 30px);
      overflow: auto;
      position: relative;
    }
    .resize-handle {
      position: absolute;
      width: 16px;
      height: 16px;
      bottom: 0;
      right: 0;
      cursor: se-resize;
      background: rgba(0,0,0,0.3);
    }
    /* Finder icon animations */
    .finder-icon {
      width: 64px;
      text-align: center;
      cursor: pointer;
      position: absolute;
      transition: transform 0.2s ease;
    }
    .finder-icon:hover {
      transform: scale(1.05);
    }
    .finder-icon svg, .finder-icon img {
      width: 48px;
      height: 48px;
      display: block;
      margin: 0 auto;
    }
    #desktop-content .finder-icon div {
      color: #fff;
      background: rgba(0,0,0,0.5);
      padding: 2px 4px;
      border-radius: 4px;
      margin-top: 2px;
      font-size: 12px;
      cursor: default;
    }
    #dock {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.8);
      padding: 5px;
      border-top: 1px solid #aaa;
      display: flex;
      gap: 5px;
      z-index: 1000;
    }
    .dock-icon {
      padding: 5px;
      background: #ddd;
      border: 1px solid #aaa;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    #finder-context-menu {
      position: absolute;
      display: none;
      background: #fff;
      border: 1px solid #aaa;
      border-radius: 8px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      z-index: 1500;
    }
    #finder-context-menu ul {
      list-style: none;
      margin: 0;
      padding: 5px 0;
    }
    #finder-context-menu ul li {
      padding: 5px 20px;
      cursor: pointer;
    }
    #finder-context-menu ul li:hover { background: #b0c4de; }
    .desktop-window {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      background: transparent;
      pointer-events: auto;
    }
    .finder-content {
      width: 100%;
      height: 100%;
      position: relative;
    }
    #desktop-background {
      position: absolute;
      top: 0;
      left: 0;
      z-index: -1;
    }
  </style>
</head>
<body class="theme-modern">
  <div id="drag-layer"></div>
  <svg id="icons">
    <symbol id="icon-apple" viewBox="0 0 24 24">
      <path d="M16.5 1.7c-.9.9-2.4 1.7-3.8 1.5-.2-1.5.5-3 1.4-3.9.9-1 2.4-1.6 3.8-1.6.2 1.6-.4 3-1.4 4zm2.6 6.8c-1.3-1.6-2.8-2.3-4.4-2.3-2.1 0-3 1-4.5 1s-2.6-1-4.5-1c-1.7 0-3.6 1-4.9 2.8-2.1 3-1.8 8.6 1.7 13.1 1.2 1.6 2.7 3.4 4.7 3.4s2.6-1 4.5-1 2.9 1 4.5 1c2 0 3.5-1.8 4.7-3.4.7-1 1.3-2 1.7-3.1-4.6-1.7-5.3-8.2-.8-10.4z"/>
    </symbol>
    <symbol id="icon-finder" viewBox="0 0 64 64">
      <rect x="4" y="4" width="56" height="56" rx="8" ry="8" fill="#B0C4DE" stroke="#000" stroke-width="2"/>
      <circle cx="22" cy="26" r="4" fill="#000"/>
      <circle cx="42" cy="26" r="4" fill="#000"/>
      <path d="M20,40 Q32,50 44,40" stroke="#000" stroke-width="2" fill="none"/>
    </symbol>
    <symbol id="icon-folder" viewBox="0 0 64 64">
      <path d="M8 20H56V52H8Z" fill="#FCD116" stroke="#A67C00" stroke-width="2"/>
      <path d="M8 20H24V12H8Z" fill="#FCD116" stroke="#A67C00" stroke-width="2"/>
    </symbol>
    <symbol id="icon-file" viewBox="0 0 64 64">
      <path d="M12 4H44L60 20V60H12Z" fill="#fff" stroke="#000" stroke-width="2"/>
      <line x1="20" y1="16" x2="44" y2="16" stroke="#000" stroke-width="2"/>
      <line x1="20" y1="28" x2="44" y2="28" stroke="#000" stroke-width="2"/>
      <line x1="20" y1="40" x2="44" y2="40" stroke="#000" stroke-width="2"/>
    </symbol>
    <symbol id="icon-trash" viewBox="0 0 64 64">
      <rect x="16" y="20" width="32" height="36" fill="#ccc" stroke="#000" stroke-width="2"/>
      <line x1="16" y1="20" x2="48" y2="20" stroke="#000" stroke-width="2"/>
      <rect x="24" y="8" width="16" height="12" fill="#ccc" stroke="#000" stroke-width="2"/>
    </symbol>
  </svg>

  <!-- Desktop background -->
  <svg id="desktop-background" width="100%" height="100%" viewBox="0 0 800 600" preserveAspectRatio="none">
    <defs>
      <linearGradient id="bgGradient" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#008080">
          <animate attributeName="stop-color" values="#008080;#20B2AA;#008080" dur="20s" repeatCount="indefinite"/>
        </stop>
        <stop offset="100%" stop-color="#20B2AA">
          <animate attributeName="stop-color" values="#20B2AA;#008080;#20B2AA" dur="20s" repeatCount="indefinite"/>
        </stop>
      </linearGradient>
    </defs>
    <rect width="100%" height="100%" fill="url(#bgGradient)" />
    <circle cx="400" cy="300" r="100" fill="rgba(200, 200, 200, 0.3)">
      <animate attributeName="cx" values="380;420;380" dur="30s" repeatCount="indefinite"/>
      <animate attributeName="cy" values="300;320;300" dur="30s" repeatCount="indefinite"/>
    </circle>
    <ellipse cx="400" cy="300" rx="150" ry="80" fill="rgba(255, 255, 255, 0.2)">
      <animateTransform attributeName="transform" attributeType="XML"
                        type="rotate"
                        from="0 400 300"
                        to="360 400 300"
                        dur="60s"
                        repeatCount="indefinite"/>
    </ellipse>
  </svg>

  <div id="desktop">
    <div id="menu-bar">
      <div class="menu-item" id="apple-menu">
        <svg width="16" height="16"><use xlink:href="#icon-apple"></use></svg>
        Apple
        <ul class="dropdown" id="apple-dropdown">
          <li data-action="about">About This Mac</li>
          <li data-action="system">System Preferences...</li>
          <li data-action="restart">Restart...</li>
          <li data-action="shutdown">Shut Down...</li>
        </ul>
      </div>
      <div class="menu-item" id="file-menu">
        File
        <ul class="dropdown" id="file-dropdown">
          <li data-action="new-finder">New Finder Window</li>
          <li data-action="new-folder">New Folder</li>
          <li data-action="new-file">New File</li>
          <li data-action="empty-trash">Empty Trash</li>
        </ul>
      </div>
      <div id="desktop-clock"></div>
    </div>
    <div id="desktop-finder" class="desktop-window">
      <div class="finder-content" id="desktop-content"></div>
    </div>
    <div id="finder-context-menu">
      <ul>
        <li data-action="new-folder">New Folder</li>
        <li data-action="new-file">New File</li>
      </ul>
    </div>
  </div>
  <div id="window-container"></div>
  <div id="dock"></div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Global system configuration with theme (persisted)
      window.systemConfig = localStorage.getItem("systemConfig")
          ? JSON.parse(localStorage.getItem("systemConfig"))
          : { theme: "modern", language: "en", desktopBackground: "#008080" };
      // Apply theme class on body
      document.body.classList.remove("theme-modern", "theme-classicos9");
      document.body.classList.add(
        window.systemConfig.theme === "classic-os9" ? "theme-classicos9" : "theme-modern"
      );

      // Helper functions
      var $ = function(s, p){ return (p || document).querySelector(s); },
          $$ = function(s, p){ return Array.prototype.slice.call((p || document).querySelectorAll(s)); },
          on = function(e, t, h, o){ e && e.addEventListener(t, h, o); return e; },
          create = function(t, a, c) {
            var el = (t.indexOf("svg:") === 0)
                     ? document.createElementNS("http://www.w3.org/2000/svg", t.substring(4))
                     : document.createElement(t);
            if(a) Object.keys(a).forEach(function(k) {
              if(k === "text") el.textContent = a[k];
              else if(k === "html") el.innerHTML = a[k];
              else if(k === "style" && typeof a[k] === "object")
                Object.keys(a[k]).forEach(function(sk){ el.style[sk] = a[k][sk]; });
              else if(k === "data" && typeof a[k] === "object")
                Object.keys(a[k]).forEach(function(dk){ el.dataset[dk] = a[k][dk]; });
              else if(k.indexOf("on") === 0 && typeof a[k] === "function")
                on(el, k.substring(2).toLowerCase(), a[k]);
              else if(k === "xlink:href")
                el.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", a[k]);
              else el.setAttribute(k, a[k]);
            });
            if(c) (Array.isArray(c) ? c : [c]).forEach(function(child) {
              el.appendChild(typeof child === "string" ? document.createTextNode(child) : child);
            });
            return el;
          },
          zIndexCounter = 300,
          activeWindow = null,
          newFolderCounter = 1,
          newFileCounter = 1,
          openFinderWindows = [];

      // --- Refactored Drop Handler using new features ---
  function setupExternalLinkDrop(container) {
    container.addEventListener("dragover", function(e) {
      e.preventDefault();
    });
    container.addEventListener("drop", function(e) {
      e.preventDefault();
      var data = e.dataTransfer.getData("text/uri-list") || e.dataTransfer.getData("text/plain");
      if (!data && e.dataTransfer.files && e.dataTransfer.files.length) {
         var file = e.dataTransfer.files[0];
         data = URL.createObjectURL(file);
         console.log("Dropped file; blob URL:", data);
      }
      console.log("Dropped data:", data);
      if (data && (data.startsWith("http") || data.startsWith("blob:"))) {
         // Attempt to fetch page details: title and icon.
         getPageDetails(data)
         .then(function(details) {
             var pageTitle = details.title;
             var iconUrl = details.iconUrl;
             addFinderIcon(container, "app", pageTitle, e.offsetX, e.offsetY, { 
                 type: "app",
                 label: pageTitle,
                 url: data,
                 icon: iconUrl,
                 action: function() { OS.createHTMLWindow(pageTitle, data, 800, 600); }
             });
         })
         .catch(function(err) {
             console.error("Failed to fetch page details:", err);
             // Fallback: use dropped URL as title and default icon.
             addFinderIcon(container, "app", data, e.offsetX, e.offsetY, {
                 type: "app",
                 label: data,
                 url: data,
                 action: function() { OS.createHTMLWindow("Link App", data, 800, 600); }
             });
         });
      }
    });
  }

      // -----------------------------
      // Core window and drag/drop functions
      function dragElement(el, e){
        e.preventDefault();
        var posX = e.clientX, posY = e.clientY;
        document.onmouseup = function(){ document.onmouseup = null; document.onmousemove = null; };
        document.onmousemove = function(ev){
          ev.preventDefault();
          var dx = posX - ev.clientX, dy = posY - ev.clientY;
          posX = ev.clientX;
          posY = ev.clientY;
          el.style.top = (el.offsetTop - dy) + "px";
          el.style.left = (el.offsetLeft - dx) + "px";
        };
      }
      function initResize(w, e){
        e.preventDefault();
        var sX = e.clientX, sY = e.clientY, sW = w.offsetWidth, sH = w.offsetHeight;
        function doR(ev){ 
          w.style.width = (sW + ev.clientX - sX) + 'px';
          w.style.height = (sH + ev.clientY - sY) + 'px';
        }
        function stopR(){ 
          document.removeEventListener("mousemove", doR);
          document.removeEventListener("mouseup", stopR);
        }
        document.addEventListener("mousemove", doR);
        document.addEventListener("mouseup", stopR);
      }
      function minimizeWindow(w){
        w.style.display = "none";
        var d = $("#dock"),
            di = document.createElement("div");
        di.classList.add("dock-icon");
        di.textContent = w.querySelector(".title").textContent;
        di.addEventListener("click", function(){ restoreWindow(w, di); });
        d.appendChild(di);
      }
      function restoreWindow(w, di){
        w.style.display = "block";
        w.style.zIndex = zIndexCounter++;
        di.remove();
      }
      // Animate window close: add "closing" class then remove after transition ends.
      function animateClose(w) {
        w.classList.remove("show");
        w.classList.add("closing");
        setTimeout(function(){
          w.remove();
        }, 300); // match transition duration
      }
      function createWindow(t, html){
        var w = document.createElement("div");
        w.classList.add("window");
        w.style.top = "100px";
        w.style.left = "100px";
        w.style.width = "400px";
        w.style.height = "300px";
        w.style.zIndex = zIndexCounter++;
        w.addEventListener("mousedown", function(){ 
          activeWindow = w; 
          w.style.zIndex = zIndexCounter++; 
        });
        var h = document.createElement("div");
        h.classList.add("window-header");
        // Place controls on the left:
        var ctr = document.createElement("div");
        ctr.classList.add("window-controls");
        var cl = document.createElement("span");
        cl.classList.add("close");
        cl.title = "Close";
        cl.addEventListener("click", function(e){ 
          e.stopPropagation(); 
          animateClose(w);
        });
        ctr.appendChild(cl);
        var mn = document.createElement("span");
        mn.classList.add("minimize");
        mn.title = "Minimize";
        mn.addEventListener("click", function(e){ 
          e.stopPropagation(); 
          minimizeWindow(w);
        });
        ctr.appendChild(mn);
        var mx = document.createElement("span");
        mx.classList.add("maximize");
        mx.title = "Maximize/Restore";
        mx.addEventListener("click", function(e){
          e.stopPropagation();
          if(w.dataset.maximized === "true"){
            var orig = JSON.parse(w.dataset.originalRect);
            w.style.top = orig.top;
            w.style.left = orig.left;
            w.style.width = orig.width;
            w.style.height = orig.height;
            w.dataset.maximized = "false";
          } else {
            w.dataset.originalRect = JSON.stringify({ top: w.style.top, left: w.style.left, width: w.style.width, height: w.style.height });
            w.style.top = "24px";
            w.style.left = "0px";
            w.style.width = "100%";
            w.style.height = "calc(100% - 24px)";
            w.dataset.maximized = "true";
          }
        });
        ctr.appendChild(mx);
        h.appendChild(ctr);
        var ts = document.createElement("span");
        ts.classList.add("title");
        ts.textContent = t;
        h.appendChild(ts);
        w.appendChild(h);
        var cd = document.createElement("div");
        cd.classList.add("window-content");
        cd.style.position = "relative";
        cd.innerHTML = html;
        w.appendChild(cd);
        h.addEventListener("mousedown", function(e){ dragElement(w, e); });
        var rh = document.createElement("div");
        rh.classList.add("resize-handle");
        w.appendChild(rh);
        rh.addEventListener("mousedown", function(e){ e.stopPropagation(); initResize(w, e); });
        $("#window-container").appendChild(w);
        setTimeout(function() { w.classList.add("show"); }, 10);
        return w;
      }
      function addFinderIcon(container, type, label, left, top, itemData, store) {
    var icon = create("div", { class: "finder-icon", style: {
      left: (itemData && itemData.isTrash && container.id === "desktop-content") ? "auto" : left + "px",
      top: (itemData && itemData.isTrash && container.id === "desktop-content") ? "auto" : top + "px",
      right: (itemData && itemData.isTrash && container.id === "desktop-content") ? "10px" : "auto",
      bottom: (itemData && itemData.isTrash && container.id === "desktop-content") ? "10px" : "auto",
      position: "absolute",
      width: "64px"
    }});
    // For apps, if a custom icon URL exists, use an <img> instead of SVG.
    if(type === "app" && itemData && itemData.icon && !itemData.icon.startsWith("#")) {
      var img = document.createElement("img");
      img.src = itemData.icon;
      icon.appendChild(img);
    } else {
      var svg = create("svg:svg", { width: "48", height: "48" }),
          use = create("svg:use", { "xlink:href": type === "folder" ? (itemData && itemData.isTrash ? "#icon-trash" : "#icon-folder") : (type === "file" ? "#icon-file" : "#icon-finder") });
      svg.appendChild(use);
      icon.appendChild(svg);
    }
    var txt = create("div", { text: label });
    icon.appendChild(txt);
    if(itemData) {
      icon.storedItem = itemData;
    } else if(store) {
      var newItem = { type: type, label: label, left: left, top: top, folderContents: type === "folder" ? [] : undefined };
      icon.storedItem = newItem;
      if(container.folderData && container.folderData.folderContents) {
        FilesystemAPI.addItem(container.folderData, newItem);
      }
    }
    // Existing mousedown and dblclick handlers...
    on(icon, "mousedown", function(e) { startDrag(icon, e); e.stopPropagation(); });
    on(icon, "dblclick", function(e) {
      if(icon.storedItem) {
        if(icon.storedItem.type === "folder") {
          openFolderWindow(icon.storedItem);
        } else if(icon.storedItem.type === "app") {
          icon.storedItem.action && icon.storedItem.action();
        } else if(icon.storedItem.type === "file") {
          alert('File "' + icon.storedItem.label + '" opened.');
        }
      }
      e.stopPropagation();
    });
    // --- New: Context menu on right-click for apps ---
    icon.addEventListener("contextmenu", function(e) {
      e.preventDefault();
      e.stopPropagation();
      if (icon.storedItem && icon.storedItem.type === "app") {
        // Remove any existing icon context menu.
        var existingMenu = document.getElementById("icon-context-menu");
        if (existingMenu) existingMenu.remove();

        var menu = document.createElement("div");
        menu.id = "icon-context-menu";
        menu.style.position = "absolute";
        menu.style.background = "#fff";
        menu.style.border = "1px solid #aaa";
        menu.style.borderRadius = "4px";
        menu.style.boxShadow = "2px 2px 5px rgba(0,0,0,0.3)";
        menu.style.padding = "5px";
        menu.style.zIndex = "10000";
        menu.innerHTML = '<div style="padding: 5px; cursor: pointer;">Open</div>';
        menu.style.left = e.pageX + "px";
        menu.style.top = e.pageY + "px";
        document.body.appendChild(menu);
        menu.firstChild.addEventListener("click", function() {
          if (icon.storedItem && icon.storedItem.action) {
            icon.storedItem.action();
          }
          menu.remove();
        });
        document.addEventListener("click", function handler() {
          menu.remove();
          document.removeEventListener("click", handler);
        });
      }
    });
    container.appendChild(icon);
  }
      function startDrag(el, e){
        var initialX = e.clientX, initialY = e.clientY,
            origRect = el.getBoundingClientRect(),
            origLeft = origRect.left, origTop = origRect.top,
            offsetX = e.clientX - origLeft, offsetY = e.clientY - origTop,
            dragging = false, origContainer = el.parentElement;
        function onMouseMove(ev){
          var dx = ev.clientX - initialX, dy = ev.clientY - initialY;
          if(!dragging && Math.sqrt(dx*dx + dy*dy) > 5){
            dragging = true;
            var dl = $("#drag-layer");
            el.style.left = origLeft + "px";
            el.style.top = origTop + "px";
            dl.appendChild(el);
            el.style.position = "absolute";
            el.style.zIndex = 3001;
          }
          if(dragging){
            el.style.left = (origLeft + dx) + "px";
            el.style.top = (origTop + dy) + "px";
          }
        }
        function onMouseUp(ev){
          document.removeEventListener("mousemove", onMouseMove);
          document.removeEventListener("mouseup", onMouseUp);
          if(!dragging) return;
          var finalX = ev.clientX, finalY = ev.clientY;
          el.style.display = "none";
          var dropEl = document.elementFromPoint(finalX, finalY), folderTarget = null;
          while(dropEl && !folderTarget){
            if(dropEl.classList && dropEl.classList.contains("finder-icon") &&
               dropEl !== el && dropEl.storedItem && (dropEl.storedItem.type === "folder" || dropEl.storedItem.isTrash)){
              folderTarget = dropEl;
              break;
            }
            dropEl = dropEl.parentElement;
          }
          if(folderTarget){
            var targetFolder = folderTarget.storedItem;
            if(origContainer.folderData && el.storedItem){
              FilesystemAPI.removeItem(origContainer.folderData, el.storedItem);
            }
            if(targetFolder && targetFolder.folderContents){
              el.storedItem.left = 20 + (targetFolder.folderContents.length % 3) * 80;
              el.storedItem.top = 20 + Math.floor(targetFolder.folderContents.length / 3) * 80;
              FilesystemAPI.addItem(targetFolder, el.storedItem);
              el.remove();
              return;
            }
          }
          dropEl = document.elementFromPoint(finalX, finalY);
          var dropTarget = null;
          while(dropEl && !dropTarget){
            if(dropEl.classList && dropEl.classList.contains("finder-content")){
              dropTarget = dropEl;
              break;
            }
            dropEl = dropEl.parentElement;
          }
          if(!dropTarget){
            dropEl = document.elementFromPoint(finalX, finalY);
            while(dropEl && !dropTarget){
              if(dropEl.classList && dropEl.classList.contains("window")){
                var fc = dropEl.querySelector(".finder-content");
                if(fc){ dropTarget = fc; break; }
              }
              dropEl = dropEl.parentElement;
            }
          }
          if(!dropTarget) dropTarget = $("#desktop-content");
          el.style.display = "";
          dropTarget.appendChild(el);
          var dropRect = dropTarget.getBoundingClientRect(),
              newLeft = finalX - dropRect.left - offsetX,
              newTop = finalY - dropRect.top - offsetY;
          newLeft = Math.max(0, Math.min(newLeft, dropTarget.offsetWidth - el.offsetWidth));
          newTop = Math.max(0, Math.min(newTop, dropTarget.offsetHeight - el.offsetHeight));
          el.style.left = newLeft + "px";
          el.style.top = newTop + "px";
          if(el.storedItem){
            el.storedItem.left = newLeft;
            el.storedItem.top = newTop;
          }
          if(origContainer.folderData && dropTarget.folderData && origContainer.folderData !== dropTarget.folderData){
            FilesystemAPI.removeItem(origContainer.folderData, el.storedItem);
            if(!dropTarget.folderData.folderContents.includes(el.storedItem))
              FilesystemAPI.addItem(dropTarget.folderData, el.storedItem);
          }
        }
        document.addEventListener("mousemove", onMouseMove);
        document.addEventListener("mouseup", onMouseUp);
      }
      function updateClock(){
        var n = new Date(), c = $("#desktop-clock"),
            h = n.getHours(), m = n.getMinutes(), s = n.getSeconds();
        if(c) { c.textContent = (h<10?"0"+h:h) + ":" + (m<10?"0"+m:m) + ":" + (s<10?"0"+s:s); }
      }
      setInterval(updateClock, 1000);
      updateClock();

      // -----------------------------
      // OS abstraction with theme change support
      var OS = {
        init: function(){ openDesktop(); },
        openFinder: function(folder){ openFinderWindow(folder); },
        createWindow: function(title, content){ return createWindow(title, content); },
        changeTheme: function(themeName) {
          window.systemConfig.theme = themeName;
          localStorage.setItem("systemConfig", JSON.stringify(window.systemConfig));
          document.body.classList.remove("theme-modern", "theme-classicos9");
          document.body.classList.add(themeName === "classic-os9" ? "theme-classicos9" : "theme-modern");
          alert("Theme changed to " + themeName);
        }
      };

      
  // --- Updated OS.createHTMLWindow with progress indicator & injection ---
  OS.createHTMLWindow = function(title, url, desiredWidth, desiredHeight) {
    var loadingHTML = '<div id="loading-indicator" style="display: flex; align-items: center; justify-content: center; height: 100%;">Loading...</div>';
    var w = OS.createWindow(title, loadingHTML);
    w.style.width = desiredWidth + 'px';
    w.style.height = desiredHeight + 'px';

    var iframe = document.createElement("iframe");
    iframe.style.width = "100%";
    iframe.style.height = "100%";
    iframe.style.border = "none";
    iframe.style.opacity = "0"; // Hidden until loaded
    iframe.src = url;

    var contentDiv = w.querySelector(".window-content");
    contentDiv.appendChild(iframe);

    iframe.onload = function() {
      try {
        iframe.contentWindow.desktopCore = {
          closeApp: function() {
            animateClose(w);
          }
          // More methods as needed.
        };
      } catch (err) {
        console.error("desktopCore injection failed:", err);
      }
      var loadingDiv = w.querySelector("#loading-indicator");
      if (loadingDiv) loadingDiv.remove();
      // Fade in the iframe.
      iframe.style.transition = "opacity 0.3s ease";
      iframe.style.opacity = "1";
      w.classList.add("show");
    };

    setTimeout(function() {
      if (iframe.style.opacity !== "1") {
        var loadingDiv = w.querySelector("#loading-indicator");
        if (loadingDiv) loadingDiv.remove();
        iframe.style.transition = "opacity 0.3s ease";
        iframe.style.opacity = "1";
        w.classList.add("show");
      }
    }, 5000);

    iframe.onerror = function() {
      var contentDiv = w.querySelector(".window-content");
      contentDiv.innerHTML = '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">' +
                             '<svg width="64" height="64"><use xlink:href="#icon-apple"></use></svg>' +
                             '<p>Page failed to load</p></div>';
    };

    return w;
  };

  function getFaviconFromIframe(iframe) {
    try {
      var doc = iframe.contentDocument || iframe.contentWindow.document;
      var icon = doc.querySelector('link[rel="icon"], link[rel="shortcut icon"]');
      if (icon) {
        var href = icon.getAttribute("href");
        // Use iframe.src as the base URL.
        try {
          return new URL(href, iframe.src).href;
        } catch (e) {
          // If URL construction fails (e.g. for blob or local files), just return href.
          return href;
        }
      }
      return null;
    } catch (err) {
      console.warn("Could not access iframe document:", err);
      return null;
    }
  }

  function getPageDetails(url) {
    return fetch(url)
      .then(function(response) { return response.text(); })
      .then(function(htmlText) {
         var parser = new DOMParser();
         var doc = parser.parseFromString(htmlText, "text/html");
         var titleEl = doc.querySelector("title");
         var title = titleEl ? titleEl.innerText : url;
         var iconEl = doc.querySelector('link[rel="icon"], link[rel="shortcut icon"]');
         var iconUrl = null;
         if (iconEl) {
           var href = iconEl.getAttribute("href");
           try {
             iconUrl = new URL(href, url).href;
           } catch (e) {
             // Fallback if URL construction fails (for blob/local file URLs)
             iconUrl = href;
           }
         }
         return { title: title, iconUrl: iconUrl };
      });
    }

  // Function to set the window icon (an SVG or image)
  function setWindowIcon(windowElement, iconUrl) {
    // Assume the title bar is the .window-header element.
    var header = windowElement.querySelector(".window-header");
    if (!header) return;
    
    // If an icon element already exists, update it; otherwise, create one.
    var iconElem = header.querySelector(".window-icon");
    if (!iconElem) {
      iconElem = document.createElement("img");
      iconElem.className = "window-icon";
      iconElem.style.width = "16px";
      iconElem.style.height = "16px";
      iconElem.style.marginRight = "5px";
      header.insertBefore(iconElem, header.firstChild);
    }
    iconElem.src = iconUrl;
  }

      // Code Editor app for editing system configuration (with theme change options added in System Preferences).
      OS.openCodeEditor = function() {
        var configText = JSON.stringify(window.systemConfig, null, 2);
        var html = '<textarea id="code-editor-textarea" style="width:100%; height: calc(100% - 80px);">' + configText + '</textarea>' +
                   '<button id="save-config-btn" style="width:100%; height: 40px;">Save Configuration</button>' +
                   '<br/><label>Theme: </label>' +
                   '<select id="theme-select">' +
                     '<option value="modern">Modern</option>' +
                     '<option value="classic-os9">Classic OS 9</option>' +
                   '</select>';
        var w = createWindow("System Preferences", html);
        w.style.width = '600px';
        w.style.height = '500px';
        setTimeout(function() {
          var textarea = document.getElementById("code-editor-textarea");
          if (textarea && window.CodeMirror) {
            var editor = CodeMirror.fromTextArea(textarea, {
              lineNumbers: true,
              mode: "application/json"
            });
            var saveBtn = document.getElementById("save-config-btn");
            if (saveBtn) {
              saveBtn.addEventListener("click", function() {
                try {
                  var newConfig = JSON.parse(editor.getValue());
                  window.systemConfig = newConfig;
                  localStorage.setItem("systemConfig", editor.getValue());
                  alert("Configuration saved!");
                } catch (e) {
                  alert("Invalid JSON: " + e.message);
                }
              });
            }
          }
          var themeSelect = document.getElementById("theme-select");
          if(themeSelect) {
            // Set initial selection based on current config.
            themeSelect.value = window.systemConfig.theme === "classic-os9" ? "classic-os9" : "modern";
            themeSelect.addEventListener("change", function() {
              OS.changeTheme(this.value);
            });
          }
        }, 0);
        return w;
      };

      // Filesystem API for shared operations
      var FilesystemAPI = {
        addItem: function(folder, item) {
          if(folder && folder.folderContents) {
            folder.folderContents.push(item);
            updateOpenFinderWindows(folder);
          }
        },
        removeItem: function(folder, item) {
          if(folder && folder.folderContents) {
            folder.folderContents = folder.folderContents.filter(function(i){ return i !== item; });
            updateOpenFinderWindows(folder);
          }
        },
        renameItem: function(folder, item, newLabel) {
          if(item) {
            item.label = newLabel;
            updateOpenFinderWindows(folder);
          }
        }
      };
      function updateOpenFinderWindows(folder) {
        openFinderWindows.forEach(function(win) {
          if(win.currentFolder === folder) {
            var fc = win.querySelector(".finder-content");
            renderFolderContents(folder, fc);
          }
        });
      }

      // Setup context menu for Finder windows
      $$("#finder-context-menu li").forEach(function(item){
        on(item, "click", function(e){
          var act = this.getAttribute("data-action");
          if(act === "new-folder" && currentContextContainer) {
            addFinderIcon(currentContextContainer, "folder", "New Folder " + newFolderCounter++, 20, 20, null, true);
          } else if(act === "new-file" && currentContextContainer) {
            addFinderIcon(currentContextContainer, "file", "New File " + newFileCounter++, 20, 20, null, true);
          }
          hideFinderContextMenu();
          e.stopPropagation();
        });
      });
      on(document, "click", function(){ 
        $("#finder-context-menu").style.display = "none"; 
        $$(".dropdown").forEach(function(menu) {
          menu.classList.remove("active");
        });
      });
      var currentContextContainer = null;
      function setupFinderContextMenu(c){ 
        on(c, "contextmenu", function(e){ 
          e.preventDefault(); 
          currentContextContainer = c; 
          showFinderContextMenu(e.pageX, e.pageY); 
        }); 
      }
      function showFinderContextMenu(x, y){ 
        var m = $("#finder-context-menu"); 
        m.style.display = "block"; 
        m.style.left = x + "px"; 
        m.style.top = y + "px";
      }
      function hideFinderContextMenu(){ 
        $("#finder-context-menu").style.display = "none"; 
      }

      // -----------------------------
      // Desktop and Finder functions
      function openDesktop(){
        var d = $("#desktop-content");
        if(!d) { console.error("desktop-content element not found"); return; }
        d.folderData = filesystem.desktop;
        renderFolderContents(filesystem.desktop, d);
        setupFinderContextMenu(d);
      }
      function renderFolderContents(folder, container){
        container.innerHTML = "";
        folder.folderContents.forEach(function(item){
          addFinderIcon(container, item.type, item.label, item.left, item.top, item, false);
        });
        setupExternalLinkDrop(container);
      }
      function openFinderWindow(folder){
        var title = folder ? folder.label : "Finder",
            html = '<div class="finder-content"></div>',
            win = createWindow(title, html);
        win.isFinder = true;
        if(folder){ 
          win.currentFolder = folder;
        }
        activeWindow = win; 
        openFinderWindows.push(win);
        var fc = win.querySelector(".finder-content");
        if(folder){ 
          fc.folderData = folder; 
          renderFolderContents(folder, fc); 
        } else { 
          fc.folderData = filesystem.desktop; 
          renderFolderContents(filesystem.desktop, fc); 
        }
        setupFinderContextMenu(fc);
      }
      function openFolderWindow(item){ openFinderWindow(item); }

      // Top Menu Bar auto-show behavior using hover with a short delay to prevent premature disappearance
      var menuHideTimeout;
      $$("#menu-bar .menu-item").forEach(function(item) {
        item.addEventListener("mouseenter", function() {
          clearTimeout(menuHideTimeout);
          $$("#menu-bar .dropdown").forEach(function(dd) {
            dd.classList.remove("active");
          });
          var dropdown = item.querySelector(".dropdown");
          if(dropdown) dropdown.classList.add("active");
        });
      });
      $("#menu-bar").addEventListener("mouseleave", function() {
        menuHideTimeout = setTimeout(function() {
          $$("#menu-bar .dropdown").forEach(function(dd) {
            dd.classList.remove("active");
          });
        }, 200);
      });
      
      // Top Menu Bar click actions (for menu item actions)
      $("#apple-dropdown").addEventListener("click", function(e) {
        var action = e.target.getAttribute("data-action");
        if (action) {
          if (action === "about") {
            alert("Retro Mac OS 9\nVersion 1.0");
          } else if (action === "system") {
            OS.openCodeEditor();
          } else if (action === "restart") {
            alert("Restarting... (not really)");
          } else if (action === "shutdown") {
            alert("Shutting down... (not really)");
          }
        }
      });
      $("#file-dropdown").addEventListener("click", function(e) {
        var action = e.target.getAttribute("data-action");
        if (action) {
          if (action === "new-finder") {
            OS.openFinder(filesystem.desktop);
          } else if (action === "new-folder") {
            addFinderIcon(document.getElementById("desktop-content"), "folder", "New Folder " + newFolderCounter++, 20, 20, null, true);
          } else if (action === "new-file") {
            addFinderIcon(document.getElementById("desktop-content"), "file", "New File " + newFileCounter++, 20, 20, null, true);
          } else if (action === "empty-trash") {
            var trashFolder = filesystem.desktop.folderContents.find(function(item) { return item.isTrash; });
            if (trashFolder) {
              trashFolder.folderContents = [];
              renderFolderContents(filesystem.desktop, document.getElementById("desktop-content"));
            }
          }
        }
      });

      // -----------------------------
      // Shared filesystem
      var filesystem = {
        desktop: {
          label: "Desktop",
          folderContents: [
            { type:"app", label:"Finder", left:250, top:50, icon:"#icon-finder",
              action: function(){ OS.openFinder(filesystem.desktop); } },
            { type:"app", label:"My App", left:50, top:50, icon:"#icon-folder",
              action: function(){ OS.createWindow("My App", '<p>This is a sample app window.</p>'); } },
            { type:"app", label:"My Picture", left:200, top:80, icon:"#icon-finder",
              action: function(){ OS.createWindow("My Picture", 
              '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 600">\n' +
              '  <defs>\n' +
              '    <linearGradient id="skyGradient" x1="0" y1="0" x2="0" y2="1">\n' +
              '      <stop offset="0%" stop-color="#FFDEE9"/>\n' +
              '      <stop offset="100%" stop-color="#B5FFFC"/>\n' +
              '    </linearGradient>\n' +
              '    <linearGradient id="hillGradient" x1="0" y1="0" x2="0" y2="1">\n' +
              '      <stop offset="0%" stop-color="#D4FC79"/>\n' +
              '      <stop offset="100%" stop-color="#96E6A1"/>\n' +
              '    </linearGradient>\n' +
              '    <radialGradient id="sunGradient" cx="0.5" cy="0.5" r="0.5">\n' +
              '      <stop offset="0%" stop-color="#FFF9C4"/>\n' +
              '      <stop offset="100%" stop-color="#FFECB3"/>\n' +
              '    </radialGradient>\n' +
              '    <radialGradient id="treeLeavesGradient" cx="0.5" cy="0.5" r="0.5">\n' +
              '      <stop offset="0%" stop-color="#B2DFDB"/>\n' +
              '      <stop offset="100%" stop-color="#80CBC4"/>\n' +
              '    </radialGradient>\n' +
              '  </defs>\n' +
              '  <rect width="100%" height="100%" fill="url(#skyGradient)" />\n' +
              '  <circle cx="700" cy="100" r="50" fill="url(#sunGradient)" />\n' +
              '  <path d="M0 500 Q400 400 800 500 L800 600 L0 600 Z" fill="url(#hillGradient)" />\n' +
              '  <g id="tree" transform="translate(200,500)">\n' +
              '    <rect x="-10" y="-60" width="20" height="60" fill="#8B4513" />\n' +
              '    <circle cx="0" cy="-80" r="40" fill="url(#treeLeavesGradient)" />\n' +
              '    <circle cx="-30" cy="-70" r="30" fill="url(#treeLeavesGradient)" />\n' +
              '    <circle cx="30" cy="-70" r="30" fill="url(#treeLeavesGradient)" />\n' +
              '  </g>\n' +
              '</svg>'); } },
            { type:"app", label:"HTML App", left:300, top:150, icon:"#icon-folder",
              action: function(){ OS.createHTMLWindow("HTML App", "https://www.example.com", 800, 600); } },
            { type:"app", label:"Code Editor", left:350, top:200, icon:"#icon-folder",
              action: function(){ OS.openCodeEditor(); } },
            { type:"folder", label:"Trash", left:0, top:0, icon:"#icon-trash", isTrash:true, folderContents: [] }
          ]
        }
      };

      // -----------------------------
      // Initialize the OS
      OS.init();
    });
  </script>
</body>
</html>